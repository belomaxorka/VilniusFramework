# Тесты для оберки базы данных

Этот каталог содержит комплексные тесты для всех компонентов оберки базы данных.

## Структура тестов

### Unit тесты (`tests/Unit/`)

#### `DatabaseManagerTest.php`
Тестирует основной класс `DatabaseManager`:
- Создание и конфигурация менеджера БД
- Подключение к различным типам БД
- Выполнение SQL запросов (SELECT, INSERT, UPDATE, DELETE)
- Обработка ошибок подключения и запросов
- Управление соединениями
- Добавление кастомных драйверов
- Получение информации о соединениях

#### `DatabaseDriversTest.php`
Тестирует драйверы базы данных:
- **MySqlDriver**: построение DSN, подключение к MySQL
- **PostgreSqlDriver**: построение DSN, подключение к PostgreSQL
- **SqliteDriver**: построение DSN, подключение к SQLite
- Проверка реализации интерфейса `DatabaseDriverInterface`

#### `QueryBuilderTest.php`
Тестирует построитель запросов `QueryBuilder`:
- Установка таблиц и колонок
- Добавление условий WHERE
- JOIN операции
- Сортировка (ORDER BY)
- Ограничения (LIMIT, OFFSET)
- Генерация SQL запросов
- Выполнение запросов и получение результатов

#### `DatabaseExceptionsTest.php`
Тестирует иерархию исключений:
- **DatabaseException**: базовое исключение БД
- **ConnectionException**: ошибки подключения
- **QueryException**: ошибки выполнения запросов
- Проверка наследования и обработки исключений

#### `DatabaseTransactionsTest.php`
Тестирует работу с транзакциями:
- Начало, подтверждение и откат транзакций
- Выполнение кода в транзакциях
- Обработка ошибок в транзакциях
- Вложенные транзакции
- Реальные сценарии (перевод денег между счетами)

#### `DatabaseBasicTest.php`
Базовые тесты для быстрой проверки работоспособности:
- Создание менеджера БД
- Подключение к SQLite
- Выполнение простых запросов
- Создание QueryBuilder

### Feature тесты (`tests/Feature/`)

#### `DatabaseIntegrationTest.php`
Интеграционные тесты с реальной базой данных:
- Сложные запросы с JOIN
- Агрегационные функции
- Подзапросы
- Пакетные операции
- Одновременные операции
- Обновления и удаления с JOIN
- Работа с большими наборами данных
- QueryBuilder с комплексными запросами
- Обработка ошибок БД

## Запуск тестов

### Запуск всех тестов
```bash
php vendor/bin/pest
```

### Запуск конкретного файла тестов
```bash
php vendor/bin/pest tests/Unit/DatabaseManagerTest.php
```

### Запуск с подробным выводом
```bash
php vendor/bin/pest --verbose
```

### Запуск только unit тестов
```bash
php vendor/bin/pest tests/Unit/
```

### Запуск только feature тестов
```bash
php vendor/bin/pest tests/Feature/
```

## Покрытие тестами

Тесты покрывают следующие аспекты:

### DatabaseManager
- ✅ Создание и конфигурация
- ✅ Подключение к БД
- ✅ Выполнение всех типов запросов
- ✅ Обработка ошибок
- ✅ Управление соединениями
- ✅ Транзакции
- ✅ Кастомные драйверы

### Драйверы БД
- ✅ MySQL драйвер
- ✅ PostgreSQL драйвер
- ✅ SQLite драйвер
- ✅ Построение DSN
- ✅ Подключение к БД

### QueryBuilder
- ✅ Построение SQL запросов
- ✅ Все типы условий
- ✅ JOIN операции
- ✅ Сортировка и ограничения
- ✅ Выполнение запросов

### Исключения
- ✅ Иерархия исключений
- ✅ Обработка ошибок
- ✅ Передача контекста

### Транзакции
- ✅ Управление транзакциями
- ✅ Обработка ошибок
- ✅ Вложенные транзакции
- ✅ Реальные сценарии

## Тестовые данные

Интеграционные тесты используют следующие тестовые таблицы:

- **users**: пользователи с полями id, name, email, age, is_active
- **posts**: посты с полями id, user_id, title, content, status
- **categories**: категории с полями id, name, description
- **post_categories**: связь многие-ко-многим между постами и категориями

## Особенности тестирования

1. **In-memory SQLite**: большинство тестов используют SQLite в памяти для быстрого выполнения
2. **Изоляция тестов**: каждый тест работает с чистой БД
3. **Реальные сценарии**: тесты включают реальные бизнес-сценарии (переводы денег, сложные запросы)
4. **Обработка ошибок**: тестируется корректная обработка различных типов ошибок
5. **Производительность**: тесты включают работу с большими наборами данных

## Добавление новых тестов

При добавлении новых тестов следуйте следующим принципам:

1. **Именование**: используйте описательные имена тестов
2. **Изоляция**: каждый тест должен быть независимым
3. **Очистка**: используйте `beforeEach` для подготовки данных
4. **Покрытие**: тестируйте как успешные, так и ошибочные сценарии
5. **Документация**: добавляйте комментарии к сложным тестам

## Требования

- PHP 8.0+
- Pest PHP
- SQLite (для большинства тестов)
- MySQL/PostgreSQL (для тестов драйверов, опционально)
