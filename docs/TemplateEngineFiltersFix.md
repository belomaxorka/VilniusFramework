# Исправление: Фильтры в условиях Twig

## Проблема

Ранее шаблонизатор не поддерживал использование фильтров в условиях `{% if %}`. Например, такой код вызывал ошибку:

```twig
{% if users|length > 0 %}
    <!-- код -->
{% endif %}
```

**Ошибка**: `Undefined variable $length`

## Решение

Добавлена обработка фильтров (пайп-операторов `|`) в метод `processCondition()` класса `TemplateEngine`. Теперь перед обработкой других операторов происходит:

1. Поиск выражений с фильтрами в условиях
2. Компиляция фильтров в соответствующие вызовы `applyFilter()`
3. Замена выражений на защищенные плейсхолдеры
4. Восстановление скомпилированных выражений на финальном этапе

## Примеры использования

### Проверка длины массива

```twig
{% if users|length > 0 %}
    <p>Найдено {{ users|length }} пользователей</p>
{% endif %}
```

### Множественные фильтры

```twig
{% if title|trim|length > 0 %}
    <h1>{{ title }}</h1>
{% endif %}
```

### Комбинирование с другими операторами

```twig
{% if (users|length > 0) and isActive %}
    <!-- код -->
{% endif %}
```

### В циклах

```twig
{% if items|length > 5 %}
    <p class="text-sm">...и еще {{ items|length - 5 }} элементов</p>
{% endif %}
```

## Технические детали

**Файл**: `core/TemplateEngine.php`  
**Метод**: `processCondition()`  
**Строки**: ~1390-1415

### Регулярное выражение

```php
'/([a-zA-Z_][a-zA-Z0-9_\.]*(?:\[[^\]]+\])*)\s*(\|[^<>=!&|]+)(?=\s*(?:[<>=!&|]|$))/'
```

Это выражение находит:
- Переменную (с возможным доступом к свойствам и элементам массива)
- Фильтры (после символа `|`)
- До операторов сравнения (`<`, `>`, `=`, `!`, `&`, `|`)

### Процесс обработки

1. Переменная и фильтры извлекаются из условия
2. Используется `splitByPipe()` для разделения на части
3. `processVariable()` обрабатывает переменную
4. `compileFilters()` компилирует фильтры
5. Результат сохраняется как `___FILTER_N___`
6. В конце все плейсхолдеры восстанавливаются

## Совместимость

Изменение полностью обратно совместимо. Все существующие шаблоны продолжат работать как прежде.

## Поддерживаемые фильтры в условиях

Все встроенные фильтры теперь работают в условиях:

- `length` / `count` - длина массива или строки
- `upper` / `lower` - регистр строки
- `trim` - удаление пробелов
- `abs` - абсолютное значение
- `first` / `last` - первый/последний элемент
- И любые другие зарегистрированные фильтры

## Примечания

- Фильтры обрабатываются ПЕРЕД другими операторами (тестами, `in`, `starts with`, и т.д.)
- Вложенные фильтры поддерживаются: `value|filter1|filter2|filter3`
- Фильтры с аргументами также работают: `text|truncate(50)`

