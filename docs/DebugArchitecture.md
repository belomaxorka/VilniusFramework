# Архитектура системы дебага

## Общая схема

```
┌─────────────────────────────────────────────────────────────┐
│                    Система дебага                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   Environment   │    │     Debug       │                │
│  │                 │    │                 │                │
│  │ • Определение   │    │ • dump()        │                │
│  │   окружения     │    │ • dd()          │                │
│  │ • isDev()       │    │ • dump_pretty() │                │
│  │ • isProd()      │    │ • collect()     │                │
│  │ • isDebug()     │    │ • trace()       │                │
│  └─────────────────┘    │ • benchmark()   │                │
│                         └─────────────────┘                │
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │  ErrorHandler   │    │   Logger        │                │
│  │                 │    │                 │                │
│  │ • handleError() │    │ • debug()       │                │
│  │ • handleExcep() │    │ • info()        │                │
│  │ • handleShut()  │    │ • warning()     │                │
│  │ • displayError()│    │ • error()       │                │
│  └─────────────────┘    └─────────────────┘                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Поток выполнения

### 1. Инициализация
```
Core::init()
├── initEnvironment()     # Загрузка .env
├── initDebugSystem()     # Регистрация обработчиков
│   ├── require debug_functions.php
│   ├── ErrorHandler::register()
│   └── Logger::addHandler()
├── initConfigLoader()
├── initializeLangManager()
└── initializeDatabase()
```

### 2. Обработка ошибок
```
Ошибка/Исключение
├── ErrorHandler::handleError()
├── processError()
├── logError() → Logger::error()
└── displayError() или displayProductionError()
```

### 3. Дебаг функции
```
dump($var, $label)
├── Environment::isDebug()?
├── formatVariable()
├── Environment::isDevelopment()?
│   ├── Да: HTML вывод на страницу
│   └── Нет: Logger::debug()
└── die? (если dd())
```

## Компоненты

### Environment
- **Назначение**: Управление окружениями
- **Функции**: Определение dev/prod, настройки отладки
- **Методы**: `get()`, `set()`, `isDevelopment()`, `isProduction()`, `isDebug()`

### Debug
- **Назначение**: Основные функции дебага
- **Функции**: Вывод переменных, сбор данных, форматирование
- **Методы**: `dump()`, `dumpPretty()`, `collect()`, `dumpAll()`, `clear()`

### ErrorHandler
- **Назначение**: Обработка ошибок и исключений
- **Функции**: Логирование, отображение ошибок
- **Методы**: `register()`, `handleError()`, `handleException()`, `handleShutdown()`

### Logger
- **Назначение**: Логирование сообщений
- **Функции**: Запись в файлы, фильтрация по уровням
- **Методы**: `debug()`, `info()`, `warning()`, `error()`, `log()`

## Глобальные функции

### Основные
- `dump($var, $label)` - вывод переменной
- `dd($var, $label)` - вывод и остановка
- `dump_pretty($var, $label)` - красивый вывод
- `dd_pretty($var, $label)` - красивый вывод и остановка

### Сбор данных
- `collect($var, $label)` - сбор без вывода
- `dump_all($die)` - вывод всех собранных данных
- `clear_debug()` - очистка собранных данных

### Дополнительные
- `trace($label)` - backtrace
- `benchmark($callback, $label)` - измерение времени
- `is_debug()`, `is_dev()`, `is_prod()` - проверка окружения
- `env($key, $default)` - переменные окружения

## Безопасность

### В разработке (development)
- Все функции дебага активны
- Детальные ошибки на странице
- HTML форматирование
- Подробные stack traces

### В продакшене (production)
- Функции дебага отключены
- Ошибки только в логах
- Общая страница ошибки
- Скрытие деталей от пользователей

## Файловая структура

```
core/
├── Environment.php          # Управление окружениями
├── Debug.php               # Основные функции дебага
├── ErrorHandler.php        # Обработка ошибок
├── debug_functions.php     # Глобальные функции
└── Core.php               # Инициализация системы

storage/logs/
└── debug.log              # Лог файл

docs/
├── Debug.md               # Полная документация
├── DebugQuickStart.md     # Быстрый старт
└── DebugArchitecture.md   # Архитектура (этот файл)
```

## Интеграция

Система автоматически интегрируется при вызове `Core::init()`:

1. Загружает переменные окружения
2. Регистрирует обработчики ошибок
3. Настраивает логгер
4. Делает глобальные функции доступными

Никаких дополнительных настроек не требуется.
